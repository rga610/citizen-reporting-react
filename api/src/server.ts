import Fastify from "fastify";import helmet from "@fastify/helmet";import cors from "@fastify/cors";import cookie from "@fastify/cookie";import crypto from "node:crypto";import { prisma } from "./db/client.js";import { assignTreatment } from "./services/treatment.js";import reportRoutes from "./routes/report.js";import sseRoutes from "./routes/sse.js";import adminRoutes from "./routes/admin.js";import surveyRoutes from "./routes/survey.js";const app = Fastify({ logger: true });app.register(helmet);app.register(cors, { origin: true, credentials: true });app.register(cookie, { secret: process.env.COOKIE_SECRET });app.addHook("onRequest", async (req, reply) => {  reply.header("Permissions-Policy", "camera=(self)");});app.get("/api/health", async () => ({ ok: true }));// Participant bootstrapapp.get("/api/join", async (req, reply) => {  const pid = req.cookies["pid"];  if (!pid) {    const slot = Number(process.env.SESSION_SLOT || "1");    let session = await prisma.session.findFirst({ where: { slot }, orderBy: { id: "desc" } });    if (!session) session = await prisma.session.create({ data: { slot, startTs: new Date() } });    const treatment = assignTreatment();    const id = crypto.randomUUID();    const publicCode = id.slice(-4);    await prisma.participant.create({      data: { id, publicCode, treatment, sessionId: session.id }    });    reply.setCookie("pid", id, { httpOnly: true, sameSite: "lax", path: "/" });    return reply.send({ status: "created", treatment, publicCode });  }  return reply.send({ status: "ok" });});app.register(reportRoutes);app.register(sseRoutes);app.register(adminRoutes);app.register(surveyRoutes);const port = Number(process.env.PORT || 3000);app.listen({ port, host: "0.0.0.0" }).catch(err => {  app.log.error(err);  process.exit(1);});